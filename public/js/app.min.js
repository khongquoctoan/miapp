var login=angular.module("AuthSrvc",[]).constant("BASE_API","https://api-popupcontact-02.mitek.vn:4431/api/v1/");login.factory("Login",["$http","$localStorage","$rootScope","BASE_API",function(t,e,o,n){function s(t,o,n){void 0===e.user?e.user={isAuthenticated:t,infos:o,roles:n}:(e.user.isAuthenticated=t,e.user.infos=o,e.user.roles=n)}return{auth:function(e){return t.post(n+"login",e).then(function(t){var e=t.data.status;return s(e.token,t.data.info,t.data.role),e},function(t){return s(!1,null,null),!1})}}}]);var crud=angular.module("CRUDSrvc",[]).constant("BASE_API","https://api-popupcontact-02.mitek.vn:4431/api/v1/");crud.factory("CustomersService",["$http","BASE_API",function(t,e){return{getCustomers:function(o,n){return t.post(e+"customers?page="+o,n)},getCustomerByID:function(o){return t.get(e+"customer/"+o)},postCustomerAndNote:function(o){return t.post(e+"postCustomerAndNote",o)},postCustomer:function(o){return t.post(e+"postCustomer",o)},putCustomer:function(o,n){return t.put(e+"putCustomer/"+o,n)},trashCustomer:function(o){return t.get(e+"deleteCustomer/"+o)},trashMultiCustomer:function(o){return t.post(e+"deleteMultiCustomer",o)},duplicateCustomer:function(o,n){return t.get(e+"duplicateCustomer/"+o,n)}}}]),crud.factory("noteService",["$http","BASE_API",function(t,e){return{insertNote:function(o,n){return t.post(e+"postNote/"+o,n)},getTags:function(o){return o=o||"",t.get(e+"getTags")}}}]);var MiApp=angular.module("MiApp",["ui.router","ui.bootstrap","ngTagsInput","ngCookies","CRUDSrvc","AuthSrvc","checklist-model","pascalprecht.translate","ngStorage","ngSanitize","oc.lazyLoad","angularMoment","cp.ngConfirm","toastr","gridshore.c3js.chart","720kb.tooltips"]);MiApp.factory("tabsService",function(){return{appTabs:[],currentActive:"",limitAppTabs:5}}),MiApp.directive("focusMe",["$timeout","$parse",function(t,e){return{link:function(o,n,s){var r=e(s.focusMe);o.$watch(r,function(e){!0===e&&t(function(){n[0].focus()})}),n.bind("blur",function(){})}}}]),MiApp.config(["$stateProvider","$urlRouterProvider","toastrConfig","$translateProvider","$httpProvider",function(t,e,o,n,s){n.useStaticFilesLoader({prefix:"app/languages/locale-",suffix:".json"}),n.preferredLanguage("vi"),n.fallbackLanguage("vi"),n.useSanitizeValueStrategy("escape"),n.useLocalStorage();var r={name:"hello",url:"/hello",template:"<h3>hello world!</h3>"},a={name:"about",url:"/about",template:"<h3>Its the UI-Router hello world app!</h3>"},i={name:"login",url:"/login",templateUrl:"app/views/login.html",controller:"loginController",controllerAs:"vm"};t.state(r),t.state(a),t.state(i),t.state("index",{url:"/index?module&type&action&anonymous&id",views:{"@":{templateUrl:"app/views/index.html",controller:"appController",controllerAs:"vm"},"header@index":{templateUrl:"app/partials/header.html"},"sidebar@index":{templateUrl:"app/partials/sidebar.html"},"footer@index":{templateUrl:"app/partials/footer.html"}},resolve:{loadPlugin:["$ocLazyLoad",function(t){return t.load([])}]},data:{requireLogin:!0}}),e.otherwise("/index?module=dashboard"),angular.extend(o,{closeButton:!0,allowHtml:!0,autoDismiss:!1,timeOut:5e3,progressBar:!0,maxOpened:0,newestOnTop:!0,positionClass:"toast-bottom-right",preventDuplicates:!1,preventOpenDuplicates:!1,target:"body"}),s.interceptors.push(["$q","$state","$localStorage",function(t,e,o){return{request:function(t){return t.headers=t.headers||{},void 0!==o.user&&o.user.isAuthenticated&&(t.headers.Authorization="Bearer "+o.user.isAuthenticated),t},responseError:function(o){return console.log(o),(401===o.status||403===o.status||400===o.status&&(["Bad Request"].indexOf(o.statusText)||o.data.error))&&e.go("login"),t.reject(o)}}}])}]),MiApp.controller("appController",["$rootScope","$scope","$translate","$state","$stateParams","toastr","$http","tabsService","$localStorage","CustomersService","noteService",function(t,e,o,n,s,r,a,i,u,c,l){e.appPModule=s.module,e.appPAction=s.action,e.appPAnonymous=s.anonymous,e.appPRecordId=s.id,e.changeLanguage=function(t){o.use(t)},e.appTabs=i.appTabs,void 0!==u.user&&u.user.isAuthenticated||(console.log("Redirect to login --"),t.$evalAsync(function(){n.go("login")}));var p=["dashboard","customers","customer","notes","monitor","reports","callhistory","users","help","feedback"];void 0!==e.appPModule&&-1!==p.indexOf(e.appPModule)||(n.go("index",{module:"dashboard"}),o(["CONSOLE_STOP"]).then(function(t){console.log("%c"+t.CONSOLE_STOP,"background:red;color:yellow;font-size:35px")})),t.pageTitle=e.appPModule.toUpperCase(),e.logout=function(){console.log("User logout ----------------"),u.user.isAuthenticated&&u.$reset(),n.go("login")},e.showTabCustomer=function(t,s,a,u){o(["ANONYMOUS","INFO_CUSTOMER"]).then(function(o){t=t||"new",a=a||"",u=u||[];var p={module:"customer",action:t,id:"",anonymous:""},h="";switch("info"===a?(s=s||0,h=u.lastName||u.firstName?u.lastName+" "+u.firstName:o.INFO_CUSTOMER,p.id=s):(s=s||(new Date).getTime()/1e3,h=o.ANONYMOUS,p.anonymous=s),e.checkTabExist(s,u).status){case-1:r.warning("Cho phép mở tối đa 5 tabs!"),e.selectTab(e.appTabs[i.currentActive].index),n.go("index",e.appTabs[i.currentActive].params);break;case 0:if(s&&"info"===a)(d=c.getCustomerByID(s)).then(function(t){void 0!==(u=t.data).info?(h=u.info.lastName||u.info.firstName?u.info.lastName+" "+u.info.firstName:o.INFO_CUSTOMER,e.appTabs.push({index:s,title:h,active:!0,type:a,params:p,customer:u}),n.go("index",p),e.selectTab(s)):e.showTabCustomer()});else{var d=l.getTags();d.then(function(t){e.appTabs.push({index:s,title:h,active:!0,type:a,params:p,customer:{tags:t.data.list}}),n.go("index",p),e.selectTab(s)})}break;case 1:n.go("index",p),e.selectTab(s)}})},e.checkTabExist=function(t,o){var n=e.appTabs,s={status:0,tabLength:n.length-1};return n.forEach(function(e){e.index===t&&(e.title=o.lastName||o.firstName?o.lastName+" "+o.firstName:e.title,s.status=1)}),n.length>i.limitAppTabs-1&&!s.status&&(s.status=-1),s},e.removeTab=function(t){e.appTabs.splice(t,1),e.appTabs.length?(i.currentActive===t&&(i.currentActive=e.appTabs.length-1),console.log(i.currentActive),e.selectTab(e.appTabs[i.currentActive].index)):(console.log("customers"),n.go("index",{module:"customers"}))},e.selectTab=function(t){e.appTabs.forEach(function(e,o){e.index===t?(e.active=!0,i.currentActive=o):e.active=!1}),console.log("Select tab: "+i.currentActive)}}]),MiApp.controller("loginController",["$scope","$http","$translate","Login","$localStorage","$location",function(t,e,o,n,s,r){t.login={lang:o.use()||"vi",email:"khongquoctoan.it@gmail.com",password:"quoctoan123"},t.changeLanguage=function(t){o.use(t)},t.userLogin=function(){n.auth(t.login).then(function(t){console.log(s.user),r.path("/")})}}]),MiApp.controller("customerActionController",["$scope","$http","$translate","$state","$stateParams","toastr","tabsService","noteService","CustomersService",function(t,e,o,n,s,r,a,i,u){t.$parent.appTabs.length||(s.id?t.showTabCustomer("new",s.id,"info"):t.showTabCustomer()),t.filteredNotes=function(t,e,o){return(o=o||[]).filter(function(o){return-1!==o.content.toLowerCase().indexOf(t?t.toLowerCase():"")&&(o.note_tags&&-1!==o.note_tags.toLowerCase().indexOf(e?e.toLowerCase():"")||!o.note_tags)})},t.addCusAndNote=function(e){u.postCustomerAndNote(e).then(function(o){o.data.status?(r.success("Đã thêm mới khách hàng!"),t.$parent.removeTab(e.index),n.go("index",{module:"customers"})):r.error("Xảy ra lỗi!")})},t.updateOrAdd=function(e,o){if(e.preventDefault(),console.log(o),o.customer.info.id)(s=u.putCustomer(o.customer.info.id,o.customer.info)).then(function(t){console.log(t),t.status?r.success("Đã cập nhật khách hàng thành công!"):r.error("Cập nhật không thành công!")});else{var s=u.postCustomer(o.customer.info);s.then(function(e){console.log(e),e.status?(r.success("Đã thêm khách hàng thành công!"),t.$parent.removeTab(o.index),n.go("index",{module:"customers"})):r.error("Không thể thêm mới thành công!")})}},t.loadTags=function(t,e){return(e=e||[]).filter(function(e){return-1!==e.tag_name.toLowerCase().indexOf(t.toLowerCase())})},t.addNote=function(t,e){t.preventDefault();var o=e.customer.info.id;o?i.insertNote(o,e.note).then(function(t){t.data.status?(e.note={},e.customer.notes?e.customer.notes.splice(0,0,t.data.list[0]):e.customer.notes=[t.data.list[0]],r.success("Đã thêm mới ghi chú!")):r.error("Ghi chú chưa được lưu!")}):r.warning("Thao tác lỗi!")},t.submitDataTab=function(t){console.log(t)}}]),MiApp.controller("customerController",["$scope","$rootScope","$http","CustomersService","$ngConfirm","toastr","$translate",function(t,e,o,n,s,r,a){var i=this;i.showSearchAdvanced=!1,i.listData=[],i.getCustomers=function(t,e){void 0===t&&(t=i.listData.current_page?i.listData.current_page:"1"),e=e||(i.listData.per_page?i.listData.per_page:10);var o={filter:i.filter,sortKey:i.sortKey,sortType:i.reverse,limit:e};n.getCustomers(t,o).then(function(t){i.listData=t.data,console.log(i.listData)})},i.sort=function(t){i.sortKey=t,i.reverse=!i.reverse,i.getCustomers()},i.checkAllCus=function(t){t.target.checked?i.listCheckCus=i.listData.data.map(function(t){return t.id}):i.listCheckCus=[]},i.checkCus=function(t,e){if(t.target.checked)if(void 0===i.listCheckCus)i.listCheckCus=[e];else{var o=!1;i.listCheckCus.forEach(function(t,n){t!==e||(o=!0)}),o||i.listCheckCus.push(e)}else i.listCheckCus.forEach(function(t,o){t!==e||i.listCheckCus.splice(o,1)})},i.deleteCus=function(e){t.trashInfo=e,a(["CONFIRM","DELETE","DELETE_SUCCESS","DELETE_FAIL","CANCEL"]).then(function(o){s({title:o.CONFIRM,content:"Bạn có chắc muốn xóa <strong>{{trashInfo}}</strong> ??",autoClose:"cancel|8000",scope:t,buttons:{delete:{text:o.DELETE,btnClass:"btn-danger",action:function(){n.trashCustomer(e)?(r.success(o.DELETE_SUCCESS),i.getCustomers()):r.error(o.DELETE_FAIL)}},cancel:{text:o.CANCEL}}})})},i.deleteMultiCustomer=function(){if(void 0===i.listCheckCus||!i.listCheckCus.length)return r.error("Chưa chọn khách hàng!");a(["CONFIRM","DELETE","DELETE_SUCCESS","DELETE_FAIL","CANCEL"]).then(function(e){s({title:e.CONFIRM,content:"Bạn có chắc muốn xóa <strong>"+i.listCheckCus.length+"</strong> khách hàng đã chọn??",autoClose:"cancel|8000",scope:t,buttons:{delete:{text:e.DELETE,btnClass:"btn-danger",action:function(){n.trashMultiCustomer({list:i.listCheckCus}).then(function(){r.success("Khách hàng được chọn đã xóa khỏi hệ thống!"),i.listCheckCus=[],i.getCustomers()},function(t){r.error("Không thể thực thi!")})}},cancel:{text:e.CANCEL}}})})}}]),MiApp.controller("dashboardController",["$scope","$http","$stateParams",function(t,e,o){t.dbParams="-------Content--------"}]);